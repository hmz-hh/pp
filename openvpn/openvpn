#!/bin/bash
export DEBIAN_FRONTEND=noninteractive

# رابط الريبو لتحميل الشهادات فقط
REPO="http://ha-vps.store/"

# الدومين من ملف موجود (تأكد أنه موجود ويحتوي على دومين صحيح)
domain=$(cat /etc/xray/domain)

# تثبيت الحزم اللازمة
apt update && apt install -y tmux openvpn wget unzip

# إنشاء مجلدات مطلوبة (لو غير موجودة)
mkdir -p /usr/lib/openvpn/
mkdir -p /var/www/html/

# إنشاء ملفات إعدادات سيرفر OpenVPN TCP و UDP (كما في سكريبتك الأصلي)
cat >/etc/openvpn/server-tcp.conf <<-EOF
port 1194
proto tcp
dev tun
ca ca.crt
cert server.crt
key server.key
dh dh.pem
verify-client-cert none
username-as-common-name
plugin /usr/lib/x86_64-linux-gnu/openvpn/plugins/openvpn-plugin-auth-pam.so login
server 10.8.0.0 255.255.255.0
ifconfig-pool-persist ipp.txt
push "redirect-gateway def1 bypass-dhcp"
push "dhcp-option DNS 8.8.8.8"
push "dhcp-option DNS 8.8.4.4"
push "route-method exe"
push "route-delay 2"
socket-flags TCP_NODELAY
push "socket-flags TCP_NODELAY"
keepalive 10 120
comp-lzo
user nobody
group nogroup
persist-key
persist-tun
management 127.0.0.1 5555
status server-tcp.log
log log-tcp.log
verb 3
ncp-disable
cipher none
auth none
EOF

cat >/etc/openvpn/server-udp.conf <<-EOF
port 2200
proto udp
dev tun
ca ca.crt
cert server.crt
key server.key
dh dh.pem
verify-client-cert none
username-as-common-name
plugin /usr/lib/x86_64-linux-gnu/openvpn/plugins/openvpn-plugin-auth-pam.so login
server 20.8.0.0 255.255.255.0
ifconfig-pool-persist ipp.txt
push "redirect-gateway def1 bypass-dhcp"
push "dhcp-option DNS 8.8.8.8"
push "dhcp-option DNS 8.8.4.4"
push "route-method exe"
push "route-delay 2"
socket-flags TCP_NODELAY
push "socket-flags TCP_NODELAY"
keepalive 10 120
comp-lzo
user nobody
group nogroup
persist-key
persist-tun
status server-udp.log
log log-udp.log
verb 3
ncp-disable
cipher none
auth none
EOF

# تحميل شهادات OpenVPN فقط من الريبو
function download_certs() {
    wget --no-check-certificate -O /etc/openvpn/server.crt "${REPO}openvpn/server.crt" >/dev/null 2>&1
    wget --no-check-certificate -O /etc/openvpn/server.key "${REPO}openvpn/server.key" >/dev/null 2>&1
    wget --no-check-certificate -O /etc/openvpn/ca.crt "${REPO}openvpn/ca.crt" >/dev/null 2>&1
    wget --no-check-certificate -O /etc/openvpn/dh.pem "${REPO}openvpn/dh.pem" >/dev/null 2>&1
}

download_certs

# إعادة تحميل النظام وتشغيل خدمات OpenVPN TCP و UDP
systemctl daemon-reload
systemctl enable openvpn@server-tcp
systemctl start openvpn@server-tcp
systemctl enable openvpn@server-udp
systemctl start openvpn@server-udp

echo "OpenVPN server-tcp and server-udp services started successfully."

echo "ملفات الـ .ovpn جاهزة للتحميل من:"
echo "http://ha-vps.store/tcp.ovpn"
echo "http://ha-vps.store/udp.ovpn"
echo "http://ha-vps.store/ssl.ovpn"
echo "http://ha-vps.store/ws-ssl.ovpn"
echo "http://ha-vps.store/all-ovpn.zip"
